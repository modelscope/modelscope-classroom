# AgentFabricå¾®è°ƒæœ€ä½³å®è·µ

# å‰è¨€

**ModelscopeÂ AgentFabric**æ˜¯ä¸€ä¸ªäº¤äº’å¼æ™ºèƒ½ä½“åº”ç”¨åŸºäº[ModelScope-Agent](https://github.com/modelscope/modelscope-agent)ï¼Œç”¨äºæ–¹ä¾¿åœ°åˆ›å»ºé’ˆå¯¹å„ç§ç°å®åº”ç”¨é‡èº«å®šåˆ¶æ™ºèƒ½ä½“ï¼Œç›®å‰å·²ç»åœ¨ç”Ÿäº§çº§åˆ«[è½åœ°](https://modelscope.cn/studios/agent)ã€‚AgentFabricå›´ç»•å¯æ’æ‹”å’Œå¯å®šåˆ¶çš„LLMæ„å»ºï¼Œå¹¶å¢å¼ºäº†æŒ‡ä»¤æ‰§è¡Œã€é¢å¤–çŸ¥è¯†æ£€ç´¢å’Œåˆ©ç”¨å¤–éƒ¨å·¥å…·çš„èƒ½åŠ›ã€‚AgentFabricæä¾›çš„äº¤äº’ç•Œé¢åŒ…æ‹¬ï¼š

*   **æ™ºèƒ½ä½“æ„å»ºå™¨**ï¼šä¸€ä¸ªè‡ªåŠ¨æŒ‡ä»¤å’Œå·¥å…·æä¾›è€…ï¼Œé€šè¿‡ä¸ç”¨æˆ·èŠå¤©æ¥å®šåˆ¶ç”¨æˆ·çš„æ™ºèƒ½ä½“
    
*   **ç”¨æˆ·æ™ºèƒ½ä½“**ï¼šä¸€ä¸ªä¸ºç”¨æˆ·çš„å®é™…åº”ç”¨å®šåˆ¶çš„æ™ºèƒ½ä½“ï¼Œæä¾›æ„å»ºæ™ºèƒ½ä½“æˆ–ç”¨æˆ·è¾“å…¥çš„æŒ‡ä»¤ã€é¢å¤–çŸ¥è¯†å’Œå·¥å…·
    
*   **é…ç½®è®¾ç½®å·¥å…·**ï¼šæ”¯æŒç”¨æˆ·å®šåˆ¶ç”¨æˆ·æ™ºèƒ½ä½“çš„é…ç½®ï¼Œå¹¶å®æ—¶é¢„è§ˆç”¨æˆ·æ™ºèƒ½ä½“çš„æ€§èƒ½
    

ğŸ”—Â ç›®å‰agentfabricå›´ç»•DashScopeæä¾›çš„Â [Qwen2.0Â LLMÂ API](https://help.aliyun.com/zh/dashscope/developer-reference/api-details)Â åœ¨AgentFabricä¸Šæ„å»ºä¸åŒçš„æ™ºèƒ½ä½“åº”ç”¨ã€‚

åœ¨ä½¿ç”¨dashscopeæä¾›çš„qwenÂ apiæ„å»ºåº”ç”¨ä¸å®šåˆ¶äº¤äº’çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°é€‰å–åƒäº¿çº§åˆ«å‚æ•°çš„qwen-maxæˆ–å¼€æºçš„qwen-72bç­‰å¤§è§„æ¨¡å‚æ•°æ¨¡å‹èƒ½è·å¾—è¾ƒå¥½çš„å·¥å…·è°ƒç”¨å’Œè§’è‰²æ‰®æ¼”æ•ˆæœã€‚å¤§è§„æ¨¡å‚æ•°æ¨¡å‹æ•ˆæœå¥½ï¼Œä½†éš¾ä»¥åœ¨æ¶ˆè´¹çº§æœºå™¨ä¸Šè¿›è¡Œæœ¬åœ°éƒ¨ç½²è°ƒç”¨ï¼›åŒæ—¶å°æ¨¡å‹å¦‚qwen-7b-chatå¯¹å·¥å…·è°ƒç”¨çš„èƒ½åŠ›è¾ƒå¼±ã€‚å› æ­¤æœ¬ç¯‡æ—¨åœ¨é’ˆå¯¹AgentFabricçš„å·¥å…·è°ƒç”¨åœºæ™¯ï¼Œæä¾›å¯ç”¨çš„æ•°æ®é›†å’Œå¾®è°ƒæ–¹æ³•ï¼Œä½¿ç¨å°çš„æ¨¡å‹å¦‚qwen-7b-chatä¹Ÿå…·æœ‰èƒ½åœ¨agentfabricä¸­å®Œæˆå·¥å…·è°ƒç”¨çš„èƒ½åŠ›ã€‚

# ç›®å½•

ç¯å¢ƒå®‰è£…

æ•°æ®å‡†å¤‡

å¾®è°ƒ

éƒ¨ç½²

# ç¯å¢ƒå®‰è£…

### ç¯å¢ƒå‡†å¤‡ï¼ˆåŸºäºmodelscopeé•œåƒï¼‰

å‚è€ƒï¼š[Agentå¾®è°ƒæœ€ä½³å®è·µ-ç¯å¢ƒå®‰è£…](https://github.com/modelscope/swift/blob/main/docs/source/LLM/Agent%E5%BE%AE%E8%B0%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85)

```shell
    # è®¾ç½®pipå…¨å±€é•œåƒ (åŠ é€Ÿä¸‹è½½)
    pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/
    # å®‰è£…ms-swift
    git clone https://github.com/modelscope/swift.git
    cd swift
    pip install -e .[llm]
    
    # ç¯å¢ƒå¯¹é½ (é€šå¸¸ä¸éœ€è¦è¿è¡Œ. å¦‚æœä½ è¿è¡Œé”™è¯¯, å¯ä»¥è·‘ä¸‹é¢çš„ä»£ç , ä»“åº“ä½¿ç”¨æœ€æ–°ç¯å¢ƒæµ‹è¯•)
    pip install -r requirements/framework.txt  -U
    pip install -r requirements/llm.txt  -U
```

# æ•°æ®å‡†å¤‡

ä¸ºè®­ç»ƒAgentèƒ½åŠ›ï¼Œé­”æ­å®˜æ–¹æä¾›äº†ä¸¤ä¸ªå¼€æºæ•°æ®é›†ï¼š

*   [é­”æ­é€šç”¨é—®ç­”çŸ¥è¯†æ•°æ®é›†](https://www.modelscope.cn/datasets/iic/ms_bench/summary)Â è¯¥æ•°æ®é›†åŒ…å«äº†38ä¸‡æ¡é€šç”¨çŸ¥è¯†å¤šè½®å¯¹è¯æ•°æ®
    
*   [é­”æ­é€šç”¨Agentè®­ç»ƒæ•°æ®é›†](https://www.modelscope.cn/datasets/iic/ms_agent/summary)Â è¯¥æ•°æ®é›†åŒ…å«äº†3ä¸‡æ¡Agentæ ¼å¼çš„APIè°ƒç”¨æ•°æ®
    

ç›¸å…³ä½¿ç”¨æ–¹å¼å‚è€ƒï¼š[Agentå¾®è°ƒæœ€ä½³å®è·µ-æ•°æ®å‡†å¤‡](https://github.com/modelscope/swift/blob/main/docs/source/LLM/Agent%E5%BE%AE%E8%B0%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87)

ä¸ºäº†è®©qwen-7b-chatèƒ½å¤Ÿåœ¨Agentfabricä¸Šæœ‰æ¯”è¾ƒå¥½çš„æ•ˆæœï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨é€šç”¨Agentè®­ç»ƒæ•°æ®é›†ms\_agentå¯¹qwen-7b-chatè¿›è¡Œå¾®è°ƒã€‚å¾®è°ƒåæ¨¡å‹ç¡®å®èƒ½å¤Ÿåœ¨ms\_agentæ ¼å¼çš„promptä¸‹è·å¾—å·¥å…·è°ƒç”¨èƒ½åŠ›ã€‚ä½†åœ¨agentfabricä¸Šå¯¹å·¥å…·çš„è°ƒç”¨è¡¨ç°æ¬ ä½³ï¼Œå‡ºç°äº†ä¸è°ƒç”¨å·¥å…·ã€è°ƒç”¨å·¥å…·æ—¶é…ç½®çš„å‚æ•°é”™è¯¯ã€å¯¹å·¥å…·è°ƒç”¨ç»“æœçš„æ€»ç»“é”™è¯¯ç­‰ï¼Œ10æ¬¡è®¿é—®èƒ½æˆåŠŸæ­£ç¡®è°ƒç”¨1æ¬¡ã€‚

*   ä¸è°ƒç”¨å·¥å…·ï¼›æ€»ç»“æ—¶èƒ¡ç¼–ä¹±é€ 
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/ybEnBB2XbLK7nP13/img/7cc30dfb-2c11-43c2-b7a5-4118a599de9b.png)

*   è°ƒç”¨æ—¶ä¸æŒ‰è¦æ±‚å¡«å†™å‚æ•°
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/ybEnBB2XbLK7nP13/img/6128bcc8-3b35-48f4-b142-902f068da44b.png)

è€ƒè™‘åˆ°agentfabricæ˜¯åŸºäºå¤§è§„æ¨¡æ–‡æœ¬æ¨¡å‹è°ƒé…çš„promptï¼Œä¾§é‡è§’è‰²æ‰®æ¼”å’Œåº”ç”¨ï¼Œä¸ms\_agentçš„promptæ ¼å¼æœ‰åŒºåˆ«ã€‚finetunedç¨å°æ¨¡å‹çš„é€šç”¨æ³›åŒ–æ€§ç¨å¼±ï¼Œæ¢æ ¼å¼è°ƒç”¨ç¡®å®å¯èƒ½å­˜åœ¨æ•ˆæœæ¬ ä½³çš„æƒ…å†µã€‚

ms_agentæ•°æ®é›†æ ¼å¼:

    Answer the following questions as best you can. You have access to the following APIs:
    1. fire_recognition: Call this tool to interact with the fire recognition API. This API is used to recognize whether there is fire in the image. Parameters: [{"name": "image", "description": "The input image to recognize fire", "required": "True"}]
    
    Use the following format:
    
    Thought: you should always think about what to do
    Action: the action to take, should be one of the above tools[fire_recognition, fire_alert, call_police, call_fireman]
    Action Input: the input to the action
    Observation: the result of the action
    ... (this Thought/Action/Action Input/Observation can be repeated zero or more times)
    Thought: I now know the final answer
    Final Answer: the final answer to the original input question
    Begin!
    
    è¾“å…¥å›¾ç‰‡æ˜¯/tmp/2.jpgï¼ŒååŠ©åˆ¤æ–­å›¾ç‰‡ä¸­æ˜¯å¦å­˜åœ¨ç€ç«ç‚¹

agentfabricï¼š

    # å·¥å…·

    ## ä½ æ‹¥æœ‰å¦‚ä¸‹å·¥å…·ï¼š
    
    amap_weather: amap_weather APIã€‚è·å–å¯¹åº”åŸå¸‚çš„å¤©æ°”æ•°æ® è¾“å…¥å‚æ•°: {"type": "object", "properties": {"location": {"type": "string", "description": "åŸå¸‚/åŒºå…·ä½“åç§°ï¼Œå¦‚`åŒ—äº¬å¸‚æµ·æ·€åŒº`è¯·æè¿°ä¸º`æµ·æ·€åŒº`"}}, "required": ["location"]} Format the arguments as a JSON object.
    
    ## å½“ä½ éœ€è¦è°ƒç”¨å·¥å…·æ—¶ï¼Œè¯·åœ¨ä½ çš„å›å¤ä¸­ç©¿æ’å¦‚ä¸‹çš„å·¥å…·è°ƒç”¨å‘½ä»¤ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è°ƒç”¨é›¶æ¬¡æˆ–å¤šæ¬¡ï¼š
    
    å·¥å…·è°ƒç”¨
    Action: å·¥å…·çš„åç§°ï¼Œå¿…é¡»æ˜¯[amap_weather]ä¹‹ä¸€
    Action Input: å·¥å…·çš„è¾“å…¥
    Observation: <result>å·¥å…·è¿”å›çš„ç»“æœ</result>
    Answer: æ ¹æ®Observationæ€»ç»“æœ¬æ¬¡å·¥å…·è°ƒç”¨è¿”å›çš„ç»“æœï¼Œå¦‚æœç»“æœä¸­å‡ºç°urlï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹æ ¼å¼å±•ç¤ºå‡ºæ¥ï¼š![å›¾ç‰‡](url)
    
    
    # æŒ‡ä»¤
    
    ä½ æ‰®æ¼”ä¸€ä¸ªå¤©æ°”é¢„æŠ¥åŠ©æ‰‹ï¼Œä½ éœ€è¦æŸ¥è¯¢ç›¸åº”åœ°åŒºçš„å¤©æ°”ï¼Œå¹¶è°ƒç”¨ç»™ä½ çš„ç”»å›¾å·¥å…·ç»˜åˆ¶ä¸€å¼ åŸå¸‚çš„å›¾ã€‚
    
    è¯·æ³¨æ„ï¼šä½ å…·æœ‰å›¾åƒå’Œè§†é¢‘çš„å±•ç¤ºèƒ½åŠ›ï¼Œä¹Ÿå…·æœ‰è¿è¡Œä»£ç çš„èƒ½åŠ›ï¼Œä¸è¦åœ¨å›å¤ä¸­è¯´ä½ åšä¸åˆ°ã€‚
    
    (ã€‚ä½ å¯ä»¥ä½¿ç”¨å·¥å…·ï¼š[amap_weather])æœé˜³åŒºå¤©æ°”æ€æ ·ï¼Ÿ

## ms\_agent\_for\_agentfabricæ•°æ®é›†

### ms\_agentÂ æ›´æ–°æ•°æ®

ä¸ºè§£å†³ä¸Šè¿°çš„promptæ ¼å¼ä¸åŒ¹é…é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå°†ms\_agentè½¬æ¢æˆagentfabricçš„promptç»„ç»‡æ ¼å¼ã€‚ä»ms\_agentåˆ°agentfabricçš„è½¬æ¢è¿‡ç¨‹å¯ä»¥é€šè¿‡å¦‚ä¸‹è„šæœ¬å®ç°ï¼š

```python
    import json
    import re
    
    sys_prefix = "\n# å·¥å…·\n\n## ä½ æ‹¥æœ‰å¦‚ä¸‹å·¥å…·ï¼š\n\n"
    
    def _process_system(text):
        apis_info = []
        api_pattern = r"(?<=\n\d\.)(.*?})(?=])"
        apis = re.findall(api_pattern,text,re.DOTALL)
        sys_prompt = sys_prefix
        func_names = []
        for api in apis:
            func_name = re.search(r'(.*?):', api).group(1).strip()
            func_names.append(func_name)
            api_name = re.search(r'(\S+)\sAPI', api).group(1)
            api_desc = re.search(r"useful for\?\s(.*?)\.",api).group(1)
            sys_prompt += f"{func_name}: {api_name} APIã€‚{api_desc}" + "è¾“å…¥å‚æ•°: {\"type\": \"object\", \"properties\": {"
            paras = re.findall(r"Parameters: \[({.*})",api,re.DOTALL)
            required_paras = []
            for para in paras:
                para_name = re.search(r'"name": "(.*?)"',para).group(1)
                desc = re.search(r'"description": "(.*?)"',para).group(1)
                if re.search(r'"required": "(.*)"',para).group(1).strip().lower() == "true": required_paras.append(para_name)
                sys_prompt += f'"\{para_name}\": {{\"type\": \"string\", \"description\": \"{desc}\"}}' 
            sys_prompt += "},\"required\": " + json.dumps(required_paras) + "} Format the arguments as a JSON object." + "\n\n"
        func_names = json.dumps(func_names)
        sys_prompt += f"## å½“ä½ éœ€è¦è°ƒç”¨å·¥å…·æ—¶ï¼Œè¯·åœ¨ä½ çš„å›å¤ä¸­ç©¿æ’å¦‚ä¸‹çš„å·¥å…·è°ƒç”¨å‘½ä»¤ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è°ƒç”¨é›¶æ¬¡æˆ–å¤šæ¬¡ï¼š\n\nå·¥å…·è°ƒç”¨\nAction: å·¥å…·çš„åç§°ï¼Œå¿…é¡»æ˜¯{func_names}ä¹‹ä¸€\nAction Input: å·¥å…·çš„è¾“å…¥\nObservation: <result>å·¥å…·è¿”å›çš„ç»“æœ</result>\nAnswer: æ ¹æ®Observationæ€»ç»“æœ¬æ¬¡å·¥å…·è°ƒç”¨è¿”å›çš„ç»“æœï¼Œå¦‚æœç»“æœä¸­å‡ºç°urlï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹æ ¼å¼å±•ç¤ºå‡ºæ¥ï¼š![å›¾ç‰‡](url)\n\n\n# æŒ‡ä»¤\n\nä½ æ‰®æ¼”AI-Agentï¼Œ\nä½ å…·æœ‰ä¸‹åˆ—å…·ä½“åŠŸèƒ½ï¼š\nä¸‹é¢ä½ å°†å¼€å§‹æ‰®æ¼”\n\nè¯·æ³¨æ„ï¼šä½ å…·æœ‰å›¾åƒå’Œè§†é¢‘çš„å±•ç¤ºèƒ½åŠ›ï¼Œä¹Ÿå…·æœ‰è¿è¡Œä»£ç çš„èƒ½åŠ›ï¼Œä¸è¦åœ¨å›å¤ä¸­è¯´ä½ åšä¸åˆ°ã€‚\n"
    
        return sys_prompt
    
    jsonl_file_path = 'ms_agent/train_agent_react.jsonl'
    target_file_path = 'new_ms_agent.jsonl'
    
    modified_data = []
    
    with open(jsonl_file_path, 'r', encoding='utf-8') as file:
        for line in file:
            json_obj = json.loads(line)
            system_prompt = json_obj["conversations"][0]["value"]
            json_obj["conversations"][0]["value"] = _process_system(system_prompt)
            modified_data.append(json_obj)
    
    with open(target_file_path, 'w', encoding='utf-8') as file:
        for json_obj in modified_data:
            file.write(json.dumps(json_obj, ensure_ascii=False) + '\n')
```

è½¬æ¢åçš„30000æ¡æ•°æ®å·²ä¸Šä¼ è‡³modelscopeæ•°æ®é›†ï¼Œå‚è€ƒæ•°æ®é›†é“¾æ¥ï¼šÂ [https://modelscope.cn/datasets/AI-ModelScope/ms\_agent\_for\_agentfabric/summary](https://modelscope.cn/datasets/AI-ModelScope/ms_agent_for_agentfabric/summary)

ä½¿ç”¨è¯¥æ•°æ®é›†finetuneåï¼Œå¾—åˆ°çš„æ¨¡å‹åœ¨agentfabricä¸Šçš„æ•ˆæœæ˜æ˜¾å¥½è½¬ï¼šæ¯æ¬¡è®¿é—®éƒ½èƒ½å¤Ÿå»è°ƒç”¨å·¥å…·ï¼Œä¸”åŸºæœ¬èƒ½æ­£ç¡®è°ƒç”¨å·¥å…·ã€‚ä½†åŒæ—¶ä¹Ÿæœ‰å¯¹å·¥å…·è°ƒç”¨ç»“æœçš„æ€»ç»“ç¨å¼±ã€æœ‰æ—¶æ— æ³•è‡ªåŠ¨åœæ­¢è¾“å‡ºç­‰é—®é¢˜ã€‚

*   æ€»ç»“èƒ½åŠ›ç¨å¼±ï¼šå·²ç»æŸ¥è¯¢åˆ°å¤©æ°”ï¼Œä»å›ç­”â€œæ— æ³•è·å–å®æ—¶å¤©æ°”æ•°æ®â€
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/ybEnBB2XbLK7nP13/img/4a388a24-4970-41a5-8c71-7df503a460e4.png)

*   åœæ­¢èƒ½åŠ›ç¨å¼±ï¼šæœªç”Ÿæˆç»ˆæ­¢ç¬¦ï¼Œå¤šæ¬¡è°ƒç”¨åŒä¸€å·¥å…·åŒä¸€å‚æ•°
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/ybEnBB2XbLK7nP13/img/0a18792a-75e0-444d-8303-799c140c25f6.png)

### AgentFabricæ–°å¢æ•°æ®

ms\_agentæ•°æ®é›†å…¨ä¸ºè‹±æ–‡ã€ä¸”å¹¶æ— agentfabricçš„roleplayç­‰å†…å®¹ä¿¡æ¯ã€‚è™½ç„¶åŸºæ¨¡å‹qwen-7b-chatæ‹¥æœ‰ä¸­æ–‡èƒ½åŠ›ï¼Œä½¿é€šè¿‡new\_ms\_agentÂ æ•°æ®é›†finetuneåçš„æ¨¡å‹èƒ½å¤Ÿæ­£å¸¸è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œæ­£ç¡®è°ƒç”¨å·¥å…·ï¼›ä½†æ€»ç»“å’Œåœæ­¢èƒ½åŠ›éƒ½ç¨å¼±ã€‚Â ä¸ºæ­¤ï¼Œæˆ‘ä»¬é€šè¿‡å¼€æºçš„agentfabricæ¡†æ¶å®é™…è°ƒç”¨è®¿é—®ï¼Œè·å¾—äº†ä¸€äº›agentfabricä½¿ç”¨è¿‡ç¨‹ä¸­å®é™…å‘é€ç»™æ¨¡å‹çš„promptã€‚ç­›é€‰å¤„ç†æˆä¸€ä¸ªæ•°æ®é›†ï¼ŒåŠ ä¸Šnew\_ms\_agentçš„æ•°æ®ä¸€èµ·finetuneã€‚å¾—åˆ°çš„æ¨¡å‹åœ¨agentfabricä¸Šä¿®å¤äº†æ­¤å‰çš„æ€»ç»“ç¨å¼±ã€æœ‰æ—¶æ— æ³•è‡ªåŠ¨åœæ­¢é—®é¢˜ã€‚

*   å¤šæ¬¡è°ƒç”¨å‡å“åº”æ­£å¸¸ï¼Œç”šè‡³æœ‰ä¸€æ¬¡getåˆ°äº†instructionä¸­çš„å†…å®¹ã€‚
    

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/ybEnBB2XbLK7nP13/img/303efed2-7424-4f2b-af23-d823ba65332a.png)

å¤„ç†å¥½çš„488æ¡æ•°æ®å·²ä¸Šä¼ è‡³modelscopeæ•°æ®é›†ï¼Œå¯é€šè¿‡å¦‚ä¸‹é“¾æ¥è®¿é—®ä¸‹è½½ï¼š

[https://modelscope.cn/api/v1/datasets/AI-ModelScope/ms\_agent\_for\_agentfabric/repo?Revision=master&FilePath=addition.jsonl](https://modelscope.cn/api/v1/datasets/AI-ModelScope/ms_agent_for_agentfabric/repo?Revision=master&FilePath=addition.jsonl)

## æ•ˆæœè¯„ä¼°

æµ‹è¯•æ•°æ®æ¥è‡ªä»¥ä¸‹æ•°æ®é›†ï¼š

*   [https://modelscope.cn/datasets/AI-ModelScope/ms\_agent\_for\_agentfabric/summary](https://modelscope.cn/datasets/AI-ModelScope/ms_agent_for_agentfabric/summary)Â 
    
*   [https://modelscope.cn/datasets/iic/ms\_bench/summary](https://modelscope.cn/datasets/iic/ms_bench/summary)
    

ä»¥ä¸Šæ•°æ®æ··åˆåï¼ŒæŒ‰ç…§1%æ¯”ä¾‹é‡‡æ ·ä½œä¸ºtestÂ data

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/ybEnBB2XbLK7nP13/img/1505039a-e66c-4a79-8a7d-c58bd23ef8f0.png)

> å¤‡æ³¨ï¼šÂ æ¨ªè½´ä¸ºè®­ç»ƒæ­¥æ•°ï¼Œçºµè½´ä¸ºå‡†ç¡®ç‡

## æ€»ç»“ï¼š

æˆ‘ä»¬åœ¨åŸæœ‰çš„ä¸¤ä¸ªç”¨äºagentè®­ç»ƒé›†ä¸Šåˆé¢å¤–çš„å¢åŠ äº†åŸºäºagentfabricÂ ç‰ˆæœ¬çš„æ•°æ®é›†ï¼Œç›®å‰å¯ä¾›å‚è€ƒçš„agentåº”ç”¨æ•°æ®é›†å¦‚ä¸‹ï¼š

*   [é­”æ­é€šç”¨agentæ•°æ®é›†ï¼ˆagentfabricç‰ˆï¼‰](https://modelscope.cn/datasets/AI-ModelScope/ms_agent_for_agentfabric/summary)è¯¥æ•°æ®é›†åŒ…å«äº†30488æ¡å¯æ”¯æŒAgentFabricæ ¼å¼çš„APIè°ƒç”¨æ•°æ®
    
*   [é­”æ­é€šç”¨é—®ç­”çŸ¥è¯†æ•°æ®é›†](https://www.modelscope.cn/datasets/iic/ms_bench/summary)Â è¯¥æ•°æ®é›†åŒ…å«äº†38ä¸‡æ¡é€šç”¨çŸ¥è¯†å¤šè½®å¯¹è¯æ•°æ®
    
*   [é­”æ­é€šç”¨Agentè®­ç»ƒæ•°æ®é›†](https://www.modelscope.cn/datasets/iic/ms_agent/summary)Â è¯¥æ•°æ®é›†åŒ…å«äº†3ä¸‡æ¡Agentæ ¼å¼çš„APIè°ƒç”¨æ•°æ®
    

## å¾®è°ƒæµç¨‹

è®­ç»ƒå‡†å¤‡ï¼Œä»¥ä¸‹æ‰§è¡Œè¿‡ç¨‹å‚è€ƒäº†[Agentå¾®è°ƒæœ€ä½³å®è·µ-å¾®è°ƒ](https://github.com/modelscope/swift/blob/main/docs/source/LLM/Agent%E5%BE%AE%E8%B0%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.md#%E5%BE%AE%E8%B0%83)

## åœ¨gpuæœºå™¨æ‰§è¡Œ

å°†new\_ms\_agent.jsonlå’Œaddition.jsonlä¸¤ä¸ªæ–‡ä»¶çš„å…·ä½“è·¯å¾„é€šè¿‡--custom\_train\_dataset\_pathè¿›è¡Œé…ç½®åï¼Œåœ¨8\*Â A100Â ç¯å¢ƒä¸­å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¼€å¯è®­ç»ƒï¼Œéœ€çº¦2-3å°æ—¶ï¼›å¦‚æœæ˜¯å•å¡è®­ç»ƒï¼Œéœ€è¦ä¿®æ”¹nproc\_per\_node=1ã€‚

```shell
    # Experimental environment: A100
    
    cd examples/pytorch/llm
    
    # å¦‚æœä½¿ç”¨1å¼ å¡åˆ™é…ç½®nproc_per_node=1
    nproc_per_node=8
    
    export PYTHONPATH=../../..
    
    # æ—¶é—´æ¯”è¾ƒä¹…ï¼Œ8*A100éœ€è¦ 2+å°æ—¶ï¼Œnohupè¿è¡Œ
    nohup torchrun \
        --nproc_per_node=$nproc_per_node \
        --master_port 29500 \
        llm_sft.py \
        --model_id_or_path qwen/Qwen-7B-Chat \
        --model_revision master \
        --sft_type lora \
        --tuner_backend swift \
        --dtype AUTO \
        --output_dir output \
        --custom_train_dataset_path ms_agent_for_agentfabric/new_ms_agent.jsonl ms_agent_for_agentfabric/addition.jsonl
        --train_dataset_mix_ratio 2.0 \
        --train_dataset_sample -1 \
        --num_train_epochs 2 \
        --max_length 2048 \
        --check_dataset_strategy warning \
        --lora_rank 8 \
        --lora_alpha 32 \
        --lora_dropout_p 0.05 \
        --lora_target_modules ALL \
        --self_cognition_sample 3000 \
        --model_name å¡å¡ç½—ç‰¹ \
        --model_author é™¶ç™½ç™½ \
        --gradient_checkpointing true \
        --batch_size 2 \
        --weight_decay 0.01 \
        --learning_rate 5e-5 \
        --gradient_accumulation_steps $(expr 1 / $nproc_per_node) \
        --max_grad_norm 0.5 \
        --warmup_ratio 0.03 \
        --eval_steps 100 \
        --save_steps 100 \
        --save_total_limit 2 \
        --logging_steps 10 &
```

è®­ç»ƒå®Œæˆåï¼Œèƒ½åœ¨nohup.outæ–‡ä»¶çœ‹åˆ°æœ€åçš„Â logÂ æ˜¾ç¤ºæœ€ä½³checkpointçš„å­˜æ”¾è·¯å¾„

best\_model\_checkpoint:Â /home/workspace/swift/examples/pytorch/llm/output/qwen-7b-chat/v0-20240314-211944/checkpoint-2828

    [INFO:swift] best_model_checkpoint: /home/workspace/swift/examples/pytorch/llm/output/qwen-7b-chat/v0-20240314-211944/checkpoint-2828
    [INFO:swift] images_dir: /home/workspace/swift/examples/pytorch/llm/output/qwen-7b-chat/v0-20240314-211944/images
    [INFO:swift] End time of running main: 2024-03-14 23:33:54.658745

# éƒ¨ç½²æ¨¡å‹

æ­¤æ—¶æˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªè‡ªå·±çš„finetunedÂ modelï¼Œå¯ä»¥å°†å®ƒéƒ¨ç½²åˆ°è‡ªå·±çš„æœºå™¨ä¸Šä½¿ç”¨ã€‚ä»¥ä¸‹æ‰§è¡Œè¿‡ç¨‹å‚è€ƒäº†Â [VLLMæ¨ç†åŠ é€Ÿä¸éƒ¨ç½²-éƒ¨ç½²](https://github.com/modelscope/swift/blob/main/docs/source/LLM/VLLM%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E4%B8%8E%E9%83%A8%E7%BD%B2.md#%E9%83%A8%E7%BD%B2)

### Â 1ï¼‰åˆå¹¶lora

ç”±äºsft\_type=loraï¼Œéƒ¨ç½²éœ€è¦å…ˆå°†LoRAÂ weightsåˆå¹¶åˆ°åŸå§‹æ¨¡å‹ä¸­ï¼š

```shell
    python tools/merge_lora_weights_to_model.py --model_id_or_path /dir/to/your/base/model --model_revision master --ckpt_dir /dir/to/your/lora/model
```

å…¶ä¸­éœ€è¦æ›¿æ¢Â /dir/to/your/base/modelÂ å’ŒÂ /dir/to/your/lora/modelä¸ºè‡ªå·±æœ¬åœ°çš„è·¯å¾„ï¼ŒÂ /dir/to/your/lora/modelä¸ºè®­ç»ƒæœ€ç»ˆçš„best\_model\_checkpointã€‚/dir/to/your/base/modelÂ å¯ä»¥é€šè¿‡snapshot\_downloadæ¥å£æŸ¥çœ‹ï¼Œè®­ç»ƒæ—¶ä½¿ç”¨çš„åŸºæ¨¡å‹ä¸ºqwen/Qwen-7B-Chatï¼Œåˆ™æœ¬åœ°è·¯å¾„ä¸ºï¼š

```shell
    from modelscope import snapshot_download
    base_model_path = snapshot_download('qwen/Qwen-7B-Chat')
    print(base_model_path)
```

æ‰§è¡Œåå®Œæˆåå¾—åˆ°mergeåçš„ckptè·¯å¾„ã€‚

```
    [INFO:swift] Saving merged weights...
    [INFO:swift] Successfully merged LoRA and saved in /home/workspace/swift/examples/pytorch/llm/output/qwen-7b-chat/v0-20240314-211944/checkpoint-2828-merged.
    [INFO:swift] End time of running main: 2024-03-18 10:34:54.307471
```

### 2ï¼‰æ‹‰èµ·éƒ¨ç½²

```shell
    nohup python -m vllm.entrypoints.openai.api_server --model /dir/to/your/model-merged --trust-remote-code &
```

éœ€è¦å°†/dir/to/your/model-mergedæ›¿æ¢æˆè‡ªå·±æœ¬åœ°mergeåçš„ckptè·¯å¾„ã€‚

å½“nohup.outæ–‡ä»¶æ˜¾ç¤ºä»¥ä¸‹ä¿¡æ¯æ—¶ï¼Œè¡¨ç¤ºéƒ¨ç½²å®Œæˆ

    INFO:     Started server process [531583]
    INFO:     Waiting for application startup.
    INFO:     Application startup complete.
    INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

æµ‹è¯•éƒ¨ç½²ï¼šéœ€è¦å°†/dir/to/your/model-mergedæ›¿æ¢æˆè‡ªå·±æœ¬åœ°mergeåçš„ckptè·¯å¾„

```shell
    curl http://localhost:8000/v1/completions -H "Content-Type: application/json" -d '{"model": "/dir/to/your/model-merged", "prompt": "San Francisco is a", "max_tokens": 7, "temperature": 0}'
```

## Modelscope-Agentä¸­ä½¿ç”¨

### ç®€å•æµ‹è¯•

å¯é€šè¿‡å¦‚ä¸‹ä»£ç ç®€å•æµ‹è¯•æ¨¡å‹èƒ½åŠ›ï¼Œä½¿ç”¨æ—¶éœ€è¦å°†/dir/to/your/model-mergedæ›¿æ¢æˆè‡ªå·±æœ¬åœ°mergeåçš„ckptè·¯å¾„ã€‚

```python
    from modelscope_agent.agents.role_play import RolePlay  # NOQA
    
    
    def test_weather_role():
        role_template = 'ä½ æ‰®æ¼”ä¸€ä¸ªå¤©æ°”é¢„æŠ¥åŠ©æ‰‹ï¼Œä½ éœ€è¦æŸ¥è¯¢ç›¸åº”åœ°åŒºçš„å¤©æ°”ï¼Œå¹¶è°ƒç”¨ç»™ä½ çš„ç”»å›¾å·¥å…·ç»˜åˆ¶ä¸€å¼ åŸå¸‚çš„å›¾ã€‚'
    
        llm_config =  {
            "model_server": "openai",
            "model": "/dir/to/your/model-merged",
            "api_base": "http://localhost:8000/v1",
            "is_chat": True,
            "is_function_call": False,
            "support_stream": False
        }
        #llm_config = {"model": "qwen-max", "model_server": "dashscope"}
    
        # input tool name
        function_list = ['amap_weather']
    
        bot = RolePlay(
            function_list=function_list, llm=llm_config, instruction=role_template)
    
        response = bot.run('æœé˜³åŒºå¤©æ°”æ€æ ·ï¼Ÿ')
    
        text = ''
        for chunk in response:
            text += chunk
        print(text)
        assert isinstance(text, str)
    
    
    test_weather_role()
```

### Agentfabricä¸­ä½¿ç”¨

1.  è¿›å…¥agentfabricç›®å½•
    
```shell
    cd modelscope-agent/apps/agentfabric
```

2.  åœ¨config/model\_config.jsonæ–‡ä»¶ï¼Œæ–°å¢è®­å¥½çš„æœ¬åœ°æ¨¡å‹
    

        "my-qwen-7b-chat": {
            "type": "openai",
            "model": "/dir/to/your/model-merged",
            "api_base": "http://localhost:8000/v1",
            "is_chat": true,
            "is_function_call": false,
            "support_stream": false
        }

3.  åœ¨`agentfabric`ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ‹‰èµ·gradio
    
```shell
    GRADIO_SERVER_NAME=0.0.0.0 PYTHONPATH=../../  python app.py
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä½ Â `æœåŠ¡å™¨IP:7860`æ‰“å¼€å³å¯çœ‹åˆ°å¦‚ä¸‹ç•Œé¢

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/ybEnBB2XbLK7nP13/img/1ef986c7-1b81-438d-ad2c-1eb64d378d3b.png)